name: Update Nix dependencies

on:
  workflow_dispatch:
  schedule:
    # Every Monday at 06:00 UTC
    - cron: "0 6 * * 1"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-deps:
    runs-on: ubuntu-latest

    env:
      FLAKE_PATH: .
      NPINS_DIR: .
      UPDATE_BRANCH: ci/update-nix-deps
      COMMIT_AUTHOR_NAME: "github-actions[bot]"
      COMMIT_AUTHOR_EMAIL: "62766066+github-actions[bot]@users.noreply.github.com" # FIXME: this is my user ID

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v31.8.4
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Show Nix version
        run: nix --version

      - name: Create or switch update branch
        run: |
          BASE_BRANCH="${GITHUB_REF_NAME#refs/heads/}"
          if git rev-parse --verify "$UPDATE_BRANCH" >/dev/null 2>&1; then
            git checkout "$UPDATE_BRANCH"
            git rebase "origin/${BASE_BRANCH}"
          else
            git checkout -b "$UPDATE_BRANCH" "origin/${BASE_BRANCH}"
          fi

      - name: Configure Git author
        run: |
          git config user.name  "${COMMIT_AUTHOR_NAME}"
          git config user.email "${COMMIT_AUTHOR_EMAIL}"

      - name: Update flake inputs
        working-directory: ${{ env.FLAKE_PATH }}
        run: |
          if [ -f flake.nix ]; then
            nix flake update
          else
            echo "No flake.nix found at $PWD, skipping flake update"
          fi

      - name: Update npins
        working-directory: ${{ env.NPINS_DIR }}
        run: |
          if [ -f sources.json ] || [ -d npins ]; then
            nix shell nixpkgs#npins --command npins update
          else
            echo "No npins configuration detected at $PWD, skipping npins update"
          fi

      - name: Check for changes
        id: diff
        run: |
          git status --porcelain
          if [ -z "$(git status --porcelain)" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          git add -A
          git commit -m "ci: update dependencies"

      - name: Push changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          git push --set-upstream origin "$UPDATE_BRANCH"

      - name: Create or update pull request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7.0.9
        with:
          branch: ${{ env.UPDATE_BRANCH }}
          title: "ci: update Nix dependencies"
          body: |
            Automated update of:

            - Flake inputs via `nix flake update`
            - npins sources via `npins update`

            This PR was created by GitHub Actions. CI must pass before merging.
          commit-message: "ci: update Nix dependencies"
          signoff: false
          delete-branch: false
